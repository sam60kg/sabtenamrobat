import telebot
from flask import Flask, request

# توکن ربات
API_TOKEN = '7174774942:AAGaPSfnHdN21Vv85yxSRX13Th5jd29-wMA'
bot = telebot.TeleBot(API_TOKEN)

# متغیرها
max_tour_capacity = 8
max_personal_capacity = 20
registered_users = []
waiting_list = []

# تابع برای ارسال پیام خوشامد به کاربران
def welcome_message(user_id, user_type):
    if user_type == "tour":
        message = (
            "سلام و خوش اومدی به برنامه دوستانه درکه 🌿😊\n"
            "ظرفیت سرویس تور تکمیل شده، ولی خوشحال می‌شیم که با وسیله شخصی خودت همراه ما باشی.\n"
            "حتماً وسایل ضروری مثل کفش و لباس مناسب، چوب‌دستی، آب و یک وعده غذا برای صبحانه رو همراه داشته باشی.\n"
            "حرکت از پای مسیر درکه ساعت ۷:۳۰ صبح شروع میشه و کل برنامه تا ساعت ۲:۳۰ بعد از ظهر تموم میشه.\n"
            "لطفاً رأس ساعت ۷:۱۵ در پای مسیر درکه حاضر باش.\n"
            "منتظرت هستیم و امیدواریم که یه روز عالی داشته باشی! 🌟\n"
            "(راهنمای تیم بعد از تموم شدن مهلت نام، لوکیشن دقیق محل پیوستنت به گروه به همراه اطلاعات بیشتر رو بهت اعلام می‌کنه)\n"
            "اگر به راهنمایی فوری نیاز داری با 09901243254 تماس بگیر."
        )
    elif user_type == "fully_booked":
        message = (
            "سلام! 🙋‍♂️\n"
            "متأسفانه ظرفیت تور (هم سرویس و هم همراه با وسیله شخصی) تکمیل شده. امیدواریم در برنامه‌های بعدی ما بتونی شرکت کنی!\n"
            "(راهنمای تیم بعد از تموم شدن مهلت ثبت‌نام، اطلاعات بیشتری درباره برنامه‌های آینده بهت اعلام می‌کنه.)\n"
            "اگر به راهنمایی فوری نیاز داری با 09901243254 تماس بگیر."
        )
    elif user_type == "personal":
        message = (
            "سلام و خوش اومدی به برنامه دوستانه درکه 🌿😊\n"
            "ظرفیت سرویس تور تکمیل شده، ولی خوشحال می‌شیم که با وسیله شخصی خودت همراه ما باشی.\n"
            "حتماً وسایل ضروری مثل کفش و لباس مناسب، چوب‌دستی، آب و یک وعده غذا برای صبحانه رو همراه داشته باشی.\n"
            "حرکت رأس ساعت ۶ صبح از خیابون گلشهر نرسیده به ورودی اتوبان، و پیمایشمون حدود ساعت ۷:۳۰ شروع میشه.\n"
            "کل برنامه تا ساعت ۲:۳۰ بعد از ظهر طول می‌کشه.\n"
            "منتظرت هستیم و امیدواریم که یه روز عالی داشته باشی! 🌟\n"
            "(راهنمای تیم بعد از تموم شدن مهلت نام، لوکیشن دقیق محل پیوستنت به گروه به همراه اطلاعات بیشتر رو بهت اعلام می‌کنه)\n"
            "اگر به راهنمایی فوری نیاز داری با 09901243254 تماس بگیر."
        )
    elif user_type == "waiting":
        message = (
            "سلام! 👋\n"
            "خوشبختانه یه جا توی سرویس تور خالی شد و تو الان جزو نفرات رزرو هستی که می‌تونی با سرویس ما به درکه بیای. 🚐\n"
            "اگه وسیله شخصی داری هم مشکلی نیست، می‌تونی با وسیله خودت هم بیای و ما رو همراهی کنی.\n"
            "منتظرت هستیم! 🌟\n"
            "(راهنمای تیم بعد از تموم شدن مهلت نام، لوکیشن دقیق محل پیوستنت به گروه به همراه اطلاعات بیشتر رو بهت اعلام می‌کنه)\n"
            "اگر به راهنمایی فوری نیاز داری با 09901243254 تماس بگیر."
        )
    
    bot.send_message(user_id, message)

# اپلیکیشن Flask برای Webhook
app = Flask(__name__)

# دریافت آپدیت‌ها از Telegram
@app.route('/' + API_TOKEN, methods=['POST'])
def get_message():
    json_str = request.get_data().decode('UTF-8')
    update = telebot.types.Update.de_json(json_str)
    bot.process_new_updates([update])
    return "!", 200

# تنظیم Webhook
@app.route("/")
def webhook():
    bot.remove_webhook()
    bot.set_webhook(https://sabtenamrobat-fp62gyrsj-00989901243254s-projects.vercel.app
/" + API_TOKEN)
    return "Webhook set!", 200

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=int(os.environ.get('PORT', 5000)))
